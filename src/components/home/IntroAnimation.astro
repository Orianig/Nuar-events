---
import type { IntroAnimationProps } from '../../types';

const {
  logoSrc = "/Logo-2.png",
  backgroundColor = "#d1cda7"
} = Astro.props as IntroAnimationProps;

const base = import.meta.env.BASE_URL;
const assetBase = base.endsWith('/') ? base : base + '/';
const logoPath = logoSrc.startsWith('http')
  ? logoSrc
  : `${assetBase}${logoSrc.replace(/^\/+/, '')}`;
---

<div id="intro-animation" class="fixed inset-0 w-screen h-screen z-50 pointer-events-none hidden">
  <div class="absolute inset-0 w-full h-full flex items-center justify-center bg-transparent">
    <div class="w-[35%] max-md:w-[40%] max-w-[250px] relative z-60 intro-anim-logo">
      <img src={logoPath} alt="NUAR Logo" class="w-full h-auto block" />
    </div>
    <div
      class="intro-anim-reveal absolute bottom-0 left-1/2 -translate-x-1/2 w-[200px] max-md:w-[160px] h-0 bg-transparent z-55"
      style={`--mask-color: ${backgroundColor};`}
    ></div>
  </div>
</div>

<script>
  const introElement = document.getElementById('intro-animation');

  if (!introElement) {
    throw null;
  }

  const navEntry = performance.getEntriesByType('navigation')[0] as PerformanceNavigationTiming | undefined;
  const navType = navEntry && 'type' in navEntry ? navEntry.type : 'navigate';

  let fromInternalPage = false;
  if (document.referrer) {
    try {
      const ref = new URL(document.referrer);
      const sameOrigin = ref.origin === window.location.origin;
      if (sameOrigin && ref.pathname !== window.location.pathname) {
        fromInternalPage = true;
      }
    } catch {
    }
  }

  const shouldPlayIntro = !fromInternalPage && navType === 'navigate';

  if (!shouldPlayIntro) {
    introElement.classList.add('hidden');
  } else {
    introElement.classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    setTimeout(() => {
      document.body.style.overflow = '';
      setTimeout(() => {
        introElement.classList.add('hidden');
      }, 300);
    }, 4700);
  }
</script>
